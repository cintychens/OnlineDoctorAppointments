<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login | Medical System</title>

    <!-- 全局样式 -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- Auth 页面专用样式（关键） -->
    <link rel="stylesheet" href="/css/auth.css">
    <!-- 图标 -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="auth-page">
<div class="auth-container">
    <!-- 左侧装饰区域 -->
    <div class="auth-decoration">
        <div class="logo">
            <i class="fas fa-heartbeat"></i>
            <h1>MedCare</h1>
            <p class="tagline">Your Health, Our Priority</p>
        </div>
        <div class="features">
            <div class="feature">
                <i class="fas fa-user-md"></i>
                <h3>Expert Doctors</h3>
                <p>Certified professionals</p>
            </div>
            <div class="feature">
                <i class="fas fa-calendar-check"></i>
                <h3>Easy Booking</h3>
                <p>Schedule appointments</p>
            </div>
            <div class="feature">
                <i class="fas fa-shield-alt"></i>
                <h3>Secure</h3>
                <p>Encrypted data</p>
            </div>
        </div>
    </div>

    <!-- 右侧登录表单 -->
    <div class="auth-form">
        <div class="form-header">
            <h2>Welcome Back</h2>
            <p>Sign in to your account</p>
        </div>

        <form id="loginForm" onsubmit="login(); return false;">
            <div class="input-group">
                <label for="username">
                    <i class="fas fa-user"></i> Username
                </label>
                <div class="input-with-icon">
                    <input type="text" id="username" placeholder="Enter your username" required>
                    <i class="fas fa-user input-icon"></i>
                </div>
            </div>

            <div class="input-group">
                <label for="password">
                    <i class="fas fa-lock"></i> Password
                </label>
                <div class="input-with-icon">
                    <input type="password" id="password" placeholder="Enter your password" required>
                    <i class="fas fa-lock input-icon"></i>
                </div>
            </div>

            <div class="form-options">
                <label class="checkbox-container">
                    <input type="checkbox" id="remember">
                    <span class="checkmark"></span>
                    Remember me
                </label>
                <a href="#" class="forgot-link">Forgot password?</a>
            </div>

            <button type="submit" class="btn-login">
                <span>Sign In</span>
                <i class="fas fa-arrow-right"></i>
            </button>

            <div class="auth-footer">
                <p>Don't have an account?
                    <a href="/auth/register.html" class="register-link">Create Account</a>
                </p>
                <p class="role-hint">
                    <i class="fas fa-info-circle"></i>
                    Select your role during registration
                </p>
            </div>
        </form>

        <div id="msg" class="error-message"></div>
    </div>

    <!-- 角色切换指示器 -->
    <div class="role-indicator">
        <div class="role-item" data-role="patient">
            <i class="fas fa-user-injured"></i>
            <span>Patient</span>
        </div>
        <div class="role-item" data-role="doctor">
            <i class="fas fa-user-md"></i>
            <span>Doctor</span>
        </div>
        <div class="role-item active" data-role="admin">
            <i class="fas fa-user-shield"></i>
            <span>Admin</span>
        </div>
    </div>
</div>

<script>
    function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const btn = document.querySelector('.btn-login');

        // 显示加载状态
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
        btn.disabled = true;

        fetch(`/api/users/login?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`, {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(async res => {
            if (!res.ok) {
                const error = await res.text();
                throw new Error(error || "Login failed");
            }
            return res.json();
        })
        .then(user => {
            localStorage.setItem("currentUser", JSON.stringify(user));

            // 显示成功消息
            document.getElementById("msg").className = "success-message";
            document.getElementById("msg").innerHTML = `
                <i class="fas fa-check-circle"></i>
                Login successful! Redirecting...
            `;

            // 添加角色跳转动画
            const role = user.role.toLowerCase();
            document.querySelectorAll('.role-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.role === role) {
                    item.classList.add('active');
                }
            });

            // 延迟跳转
            setTimeout(() => {
                if (user.role === "ADMIN") {
                    window.location.href = "/admin/dashboard.html";
                } else if (user.role === "DOCTOR") {
                    window.location.href = "/doctor/dashboard.html";
                } else {
                    window.location.href = "/patient/index.html";
                }
            }, 1500);
        })
        .catch(err => {
            document.getElementById("msg").className = "error-message";
            document.getElementById("msg").innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                ${err.message || "Invalid username or password"}
            `;

            // 添加抖动动画
            const form = document.getElementById('loginForm');
            form.classList.add('shake');
            setTimeout(() => form.classList.remove('shake'), 500);

            // 恢复按钮状态
            btn.innerHTML = '<span>Sign In</span><i class="fas fa-arrow-right"></i>';
            btn.disabled = false;
        });
    }

    // 添加键盘支持
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        // 输入时清除错误消息
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', () => {
                document.getElementById('msg').innerText = '';
            });
        });
    });
</script>
</body>
</html>