<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Appointments | Doctor Dashboard</title>

    <!-- Global styles -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/doctor.css">

    <!-- Icons -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

<!-- ================= Top Navigation ================= -->
<nav class="top-nav">
    <div class="nav-brand">
        <i class="fas fa-user-md"></i>
        <span>Doctor Dashboard</span>
    </div>

    <div class="nav-user">
        <span id="doctorName">Doctor</span>
        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>
</nav>

<!-- ================= Main Layout ================= -->
<div class="doctor-container">

    <!-- ===== Side Menu ===== -->
    <aside class="side-menu">
        <ul>
            <li>
                <a href="/doctor/dashboard.html">
                    <i class="fas fa-home"></i> Dashboard
                </a>
            </li>
            <li class="active">
                <a href="/doctor/appointments.html">
                    <i class="fas fa-calendar-check"></i> Appointments
                </a>
            </li>
            <li>
                <a href="/doctor/schedule.html">
                    <i class="fas fa-calendar-alt"></i> Schedule
                </a>
            </li>
            <li>
                <a href="/doctor/profile.html">
                    <i class="fas fa-user"></i> Profile
                </a>
            </li>
        </ul>
    </aside>

    <!-- ================= Main Content ================= -->
    <main class="main-content">

        <!-- ===== Page Header ===== -->
        <div class="card">
            <div class="card-body">
                <h2>
                    <i class="fas fa-calendar-check"></i>
                    Appointments
                </h2>
                <p>View and manage patient appointment requests</p>
            </div>
        </div>

        <!-- ===== Filters ===== -->
        <div class="card">
            <div class="card-body form-row">

                <div class="form-group">
                    <label>Status</label>
                    <select class="form-input" id="filterStatus">
                        <option value="ALL">All</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" class="form-input" id="filterDate">
                </div>

                <div class="form-group" style="align-self: flex-end;">
                    <button class="btn-primary" onclick="applyAppointmentFilter()">
                        <i class="fas fa-filter"></i> Apply
                    </button>
                </div>

            </div>
        </div>

        <!-- ===== Appointments Table ===== -->
        <div class="card">
            <div class="card-body">

                <table class="simple-table">
                    <thead>
                    <tr>
                        <th>Patient</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>

                    <tbody id="appointmentsBody">
                    <!-- rendered by JS -->
                    </tbody>
                </table>

            </div>
        </div>

    </main>
</div>

<!-- ================= Scripts ================= -->
<script>
    /* ================= Init ================= */
    let currentDoctor = null;
    let allAppointments = [];

    document.addEventListener("DOMContentLoaded", () => {
        const user = JSON.parse(localStorage.getItem("currentUser"));
        if (!user || user.role !== "DOCTOR") {
            location.href = "/auth/login.html";
            return;
        }

        currentDoctor = user;
        document.getElementById("doctorName").innerText =
            user.name || user.username || "Doctor";

        loadAppointments();
    });

    /* ================= Load ================= */
    function loadAppointments() {
        allAppointments =
            JSON.parse(localStorage.getItem("doctor_appointments")) || [];

        // 只显示当前医生的预约
        const myList = allAppointments.filter(a =>
            a.doctorName === (currentDoctor.name || currentDoctor.username)
        );

        renderAppointments(myList);
    }

    /* ================= Render ================= */
    function renderAppointments(list) {
        const tbody = document.getElementById("appointmentsBody");
        tbody.innerHTML = "";

        if (list.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align:center;color:#888;">
                        No appointments found.
                    </td>
                </tr>
            `;
            return;
        }

        list.forEach(a => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${a.patientName}</td>
                <td>${a.date}</td>
                <td>${a.time}</td>
                <td>
                    <span style="color:${statusColor(a.status)};font-weight:600;">
                        ${a.status}
                    </span>
                </td>
                <td>
                    ${renderActions(a)}
                </td>
            `;

            tbody.appendChild(tr);
        });
    }

    /* ================= Actions ================= */
    function renderActions(a) {
        if (a.status !== "pending") {
            return `<span style="color:#888;">—</span>`;
        }

        return `
            <button class="btn-primary"
                    onclick="updateStatus(${a.id}, 'approved')">
                Approve
            </button>
            <button class="btn-danger"
                    style="margin-left:6px;"
                    onclick="updateStatus(${a.id}, 'rejected')">
                Reject
            </button>
        `;
    }

    function updateStatus(id, newStatus) {
        const list =
            JSON.parse(localStorage.getItem("doctor_appointments")) || [];

        const target = list.find(a => a.id === id);
        if (!target) return;

        target.status = newStatus;

        localStorage.setItem("doctor_appointments", JSON.stringify(list));
        loadAppointments();
    }

    /* ================= Filters ================= */
    function applyAppointmentFilter() {
        const status = document.getElementById("filterStatus").value;
        const date = document.getElementById("filterDate").value;

        let filtered =
            allAppointments.filter(a =>
                a.doctorName === (currentDoctor.name || currentDoctor.username)
            );

        if (status !== "ALL") {
            filtered = filtered.filter(a => a.status === status);
        }

        if (date) {
            filtered = filtered.filter(a => a.date === date);
        }

        renderAppointments(filtered);
    }

    /* ================= Utils ================= */
    function statusColor(status) {
        switch (status) {
            case "pending": return "orange";
            case "approved": return "green";
            case "rejected": return "red";
            case "cancelled": return "gray";
            default: return "#333";
        }
    }

    /* ================= Logout ================= */
    function logout() {
        localStorage.removeItem("currentUser");
        location.href = "/auth/login.html";
    }
</script>

</body>
</html>
